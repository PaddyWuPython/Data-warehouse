# Data Warehouse Construction for New Energy Vehicle Quality and Safety Departments
## Project objectives
本项目旨在为新能源汽车质量安全管理部门构建一套数据仓库（目前针对离线场景），整合用户安全、行车安全、充电安全、电池安全、报警响应等所有相关场景的数据，实现数据的集中存储和分析利用。数据仓库将作为企业决策支持的平台，为提升车辆质量、安全管理水平提供数据支撑，通过对车辆运行过程中的传感器日志、用户反馈、充电过程记录、电池状态数据等进行汇总分析，帮助企业改进汽车性能、诊断问题以及分析驾驶行为，从而提高产品质量与用户安全。同时，数据仓库支持监管部门要求的安全监测，实现对新能源汽车运行状态的全面监控，及时发现风险并改进响应措施。最终，项目目标是打造统一的数据底座，为管理层和业务部门提供可靠、及时、完整的数据视图，辅助制定决策和优化业务流程。
## Architecture
![数仓架构](img/architecture-data.png 'Data-warehouse-architechture')
架构涵盖多源数据采集、存储、处理及应用各环节，保证数据从来源系统到最终分析的全流程打通。本项目的数据来源包括车云平台、用户App、充电桩系统、电池BMS系统和售后系统等，数据通过多种采集工具汇聚到HDFS集群的离线仓库中。
在数据采集层，我们使用 Flume、Maxwell、Kafka、DataX 等组件：
- Flume：承担车辆实时日志的采集，将大量分散的日志数据可靠地汇聚到HDFS
- Maxwell：用于捕获业务数据库的增量变更，将MySQL等源库的Binlog实时解析成JSON消息发送到Kafka
- Kafka：作为消息队列和数据总线，承接Flume和Maxwell发送的流式数据，解耦数据源和HDFS存储
- DataX：承担批量数据抽取任务，是阿里巴巴开源的异构数据源离线同步工具。通过DataX可以定时全量或增量导入关系数据库中的静态数据（如车辆主数据、历史记录）到HDFS，为数据仓库提供基础的全量数据。
在数据存储与计算层，我们采用 HDFS+Hive 的大数据仓库架构：
HDFS作为海量数据存储，Hive构建数据仓库模型并提供SQL查询接口。原始数据首先以ODS层格式存储在HDFS上，通过Hive External/Managed表映射。之后利用Hive SQL对ODS数据进行清洗转换，逐层生成DWD、DWS、ADS、DIM层的数据模型。Hive利用Hadoop的并行计算框架执行离线批处理作业，兼顾扩展性和稳定性。数据处理完成后，在应用层通过 FineBI 等BI工具对接Hive或导出的集市数据，实现可视化分析和报表展示。
## Design
- ODS
- DWD
- DWS
- ADS
- DIM 维度表
## Safety and Quality Domain Classification
- 用户安全：关注与车主/乘客相关的安全事件和反馈。例如未系安全带报警、疲劳驾驶提醒等用户行为安全数据，以及用户通过App或客服渠道提交的安全投诉、反馈。该领域的数据有助于评估用户使用过程中的安全隐患，指标包括用户安全投诉次数、投诉类别分布、投诉处理时长等。
- 行车安全：涵盖车辆行驶过程中的安全事件，包括交通事故、碰撞报警、急刹车、超速、偏离车道预警等由车辆传感器检测的事件数据。这一领域的数据主要来自车联网实时日志（每辆车定期上报速度、位置等状态，每30秒记录一次）和事故上报记录，用于分析驾驶行为和行驶安全状况。相关指标如事故次数、百公里事故率、急加速/急减速事件频次等，帮助改进驾驶安全性能。
- 充电安全：涉及新能源汽车充电过程中的安全与质量数据。例如充电过程的电压电流监控、充电温度、是否发生过热或充电故障报警等，以及充电桩与车辆交互的事件（如紧急断电、充电异常终止）。数据来源包括充电桩系统记录和车载BMS在充电时上报的数据。该域指标包括充电异常事件次数、充电过程最高温度、单次充电时长和电量等，用于评估充电安全性能和充电设施可靠性。
- 电池安全：关注动力电池的健康与安全。涵盖电池管理系统（BMS）数据，如电池单体电压、温度、SOC状态，以及BMS触发的各类电池告警（过温、过压、绝缘故障等）。这些数据通常高频由车辆BMS上传或在车辆驻车检测时提供。分析电池安全域的数据，可以监控电池状态变化，统计电池故障/告警次数、处理时长、影响范围等，支持改进电池设计和预防热失控等严重安全问题。
- 报警响应：指车辆或平台触发安全报警后的响应与处理过程。包括车辆发生事故或重大故障时发送的紧急报警，以及后台监控中心收到报警后的响应记录（如客服呼叫、救援派遣等）。该域的数据主要来自车联网平台和售后服务系统，衡量企业对安全事件的响应效率。关键指标有报警触发次数、平均响应时间、响应成功率、救援到达时间等，帮助完善应急机制。

## Monitor and operation
Dolphinscheduler
FineBI

## Data Research and complilation
| **数据表**                  | **主要字段（示例）**                                                         | **更新频率**     | **来源系统**     |
| ------------------------ | -------------------------------------------------------------------- | ------------ | ------------ |
| 车辆状态日志 (VehicleStatus)   | vehicle_id，timestamp，speed，location，battery_temp，...                 | 实时/高频（30秒一条） | 车云平台（车载终端）  |
| 充电会话记录 (ChargingSession) | session_id，vehicle_id，start_time，end_time，energy，max_temp，...        | 分钟级（充电事件触发）  | 充电桩系统        |
| 电池报警事件 (BatteryAlert)    | alert_id，vehicle_id，alert_time，alert_type，value，...                  | 分钟级（事件触发）    | 电池BMS系统      |
| 用户安全投诉 (UserComplaint)   | complaint_id，user_id，vehicle_id，complaint_time，category，severity，... | 小时级（新增投诉）    | 售后系统 / 用户App |
| 事故记录 (AccidentRecord)    | accident_id，vehicle_id，occurr_time，location，severity，...             | 天级（事故上报）     | 售后事故管理系统     |
| 车辆信息维度 (VehicleInfo)     | vehicle_id，vin，model，product_date，battery_type，...                   | 天级     | 车辆主数据（生产系统）  |

## Bus Matrix
业务总线矩阵是Kimball维度建模方法中的重要工具，其行表示业务过程，列表示公共维度，矩阵中“√”标识某业务过程涉及该维度.
| 数据主题域     | 业务过程（事实粒度）      | 时间 | 车辆 | 用户 | 地理位置 | 行驶场景 | 充电设施 | 告警类型 | 零部件 | 软件版本 | 工单 | 严重等级 |
| --------- | --------------- | -- | -- | -- | ---- | ---- | ---- | ---- | --- | ---- | -- | ---- |
| **用户安全域** | 用户安全投诉          | √  | √  | √  | √    |      |      |      |     |      | √  | √    |
|           | 用户紧急上报事件        | √  | √  | √  | √    | √    |      |      |     |      | √  | √    |
| **行车安全域** | 行驶安全事件（异常驾驶/事故） | √  | √  | √  | √    | √    |      |      |     |      |    | √    |
|           | 行车安全告警事件        | √  | √  |    | √    | √    |      | √    | √   |      |    | √    |
| **充电安全域** | 单次充电会话          | √  | √  | √  | √    |      | √    |      | √   |      |    |      |
|           | 充电异常事件          | √  | √  | √  | √    |      | √    | √    | √   |      |    | √    |
| **三电质量域** | 电池安全告警事件        | √  | √  |    | √    | √    | √    | √    | √   |      |    | √    |
|           | 三电故障事件          | √  | √  |    |      | √    |      | √    | √   |      |    | √    |
| **软件安全域** | OTA升级记录         | √  | √  | √  |      |      |      |      |     | √    |    |      |
|           | 软件异常安全事件        | √  | √  |    |      | √    |      | √    |     | √    |    | √    |
| **处置闭环域** | 安全告警响应处理        | √  | √  |    |      |      |      | √    |     |      | √  | √    |
|           | 工单处理    | √  | √  | √  |      |      |      |      | √   |      | √  | √    |

## 统计指标体系
指标体系包括原子指标以及在此基础上派生的比率、复合指标。下面按照 用户安全、行车安全、充电安全、电池安全、报警响应 五个分类列出主要的指标：
- 用户安全指标：
用户安全投诉次数：一定周期内用户提交的安全相关投诉数量，总量及按车辆型号/地区/问题类型分布。
投诉处理及时率：在规定时间（如48小时）内得到响应或解决的投诉比例（派生指标，由及时处理投诉数/总投诉数计算）。
平均投诉处理时长：从用户投诉提出到最终解决的平均耗时，反映售后响应效率。
用户安全事件数：非正式投诉但由车载系统记录的用户安全事件次数（如未系安全带警告次数、疲劳驾驶警告次数），用于评估用户安全行为情况。

- 行车安全指标：
事故发生次数：一定时期内车辆发生的事故数量，可按事故等级（轻微/重大）细分。
事故率：每万辆车每月事故次数或每百万公里事故次数，用于归一化比较安全水平（复合指标，如事故数/行驶总里程）。
危险驾驶事件次数：如急加速、急刹车、急转弯、长时间超速等事件的计数，来自车辆行驶日志分析。
平均驾驶安全评分：根据车辆传感器数据计算的驾驶行为评分（0-100），反映驾驶者安全习惯的综合评分（可由多原子指标加权形成的复合指标）。

- 充电安全指标：
充电异常次数：充电过程中出现异常断电、过温保护等异常事件的次数。
平均单次充电时长：每次完整充电的平均持续时间（分钟），可监控异常过长/过短的充电情况。
充电最高温度：充电过程中监测到的电池或充电接口的最高温度，超出安全阈值的次数也记录在案。
充电成功率：充电启动后成功完成的比例（=成功完成充电次数/总充电尝试次数），反映充电过程的可靠性（派生指标）。

- 电池安全指标：
电池告警次数：一定时期内车辆触发的电池相关报警总次数，以及按报警类型细分（如过温告警次数、过压告警次数等）。
平均电池温度：车辆在行驶或充电时电池的平均温度，及温度超标的占比时间。
电池健康SOH：电池剩余寿命/健康程度（State of Health）的平均值及分布，监控电池性能随时间的衰减。
热失控风险次数：触发严重电池故障（如热失控预警）的事件次数，此类关键指标为0则表示电池安全得到保障。

- 报警响应指标：
报警总数：监测期内系统接收到的安全报警总次数（包括事故报警、紧急救援请求等）。
平均响应时间：从报警发生到工作人员首次响应的平均时间（分钟），此指标越短越好，体现应急反应速度。
响应成功率：在服务等级协议（SLA）规定时间内成功响应并处理的报警所占比例（=按时处理报警数/总报警数）。
救援到场时间：对于需要现场救援的事故，救援人员从接警到到达现场的平均时间，以及超过阈值（如30分钟）的比例。

### 附加说明
原子指标以度量值形式存储在事实表或汇总表中，而派生指标可通过报表或视图计算得到，或在ADS层预计算存储。指标按主题分类有助于针对不同部门关注重点制作看板。
通过搭建完善的指标体系，企业能够多角度衡量新能源车的安全质量水平，并通过FineBI的可视化及时发现异常波动（如某车型事故率突增），从而采取针对性的改进措施。

## 维度表设计
>>>
- 尽可能生成丰富的维度属性
- 尽可能详细的对维度属性进行文字解释
- 区分数值型属性和事实
- 尽量沉淀通用的维度属性

- 车辆维度表 (DimVehicle)：每条记录代表一辆新能源汽车，字段包括车辆ID、车辆VIN码、车型型号、生产日期、电池类型、电池容量、所属地区/运营公司等属性。该维度由车辆主数据同步而来，可扩展属性用于分析不同车型或批次的质量问题。车辆维度通过vehicle_id与各事实表关联。

- 用户维度表 (DimUser)：记录用户/车主信息，包括用户ID、性别、年龄段、所属地区、客户类型（个人/公司）等。用户维度关联到投诉等涉及用户的事实，为分析用户属性和安全事件提供视角。

- 地理区域维度 (DimGeo)：包含地理信息，如地区ID、省、市、区域类型等。车辆、用户通常关联到地理维度（比如注册城市），事故、充电等事件也可通过经纬度映射到区域。这有助于地理层面的统计（例如事故热力图）。

- 充电站维度表 (DimChargeStation)：记录充电桩站点信息，包括站点ID、名称、站点类型（快充/慢充）、所在地理位置、运营商等。充电会话事实将引用该维度，用于统计不同站点的充电安全情况。

- 告警类型维度表 (DimAlertType)：定义安全报警/事件的类型，每条包含告警类型ID、名称、严重级别、描述等。例如类型包括碰撞报警、侧翻报警、电池过温等，用于分类报警事件事实数据。
### 说明
维度表通常数据量相对小（数百至数万级），我们通过DataX或手工导入初始化维度表，并制定定期更新机制确保维度数据新鲜（例如每天更新车辆和用户维度）。所有维度表都设有主键，并在事实表中以外键形式引用，从而实现事实-维度的关联。

## 事实表设计
>>>
1.	尽可能包含所有与业务过程相关的事实
2.	只选择与业务过程相关的事实
3.	分解不可加事实为可加事实
4.	在选择维度和事实之前必须先声明粒度
5.	在同一个事实表中不能有不同粒度的事实
6.	事实的单位要保持一致
7.	对事实的null值要处理
8.	使用退化维度提高事实表的易用性

事实表包括：
- 车辆状态明细事实表 (FactVehicleStatus)：粒度为车辆每次状态上报（约30秒一次）。外键包括日期键、时间键、车辆ID、可能还包括位置（如定位地点ID）等；度量值包括车辆速度、SOC、电池温度、电流、电压等状态数值。这是一张高频时间序列事实表，用于分析车辆运行状态和行为。由于数据量极大，我们按天对该事实表分区存储，并考虑只保留近几个月明细，在DWS层再做周期汇总。

- 事故事实表 (FactAccident)：粒度为每起事故事件。关联维度有日期、车辆、地点、司机、事故类型等；度量值包括人员伤亡数、财产损失金额（如有）、事故严重等级等。每条记录对应一次事故的发生，用于行车安全分析。

- 充电会话事实表 (FactChargingSession)：粒度为每一次充电过程（从开始到结束）记录。维度关联有日期（充电开始日期）、车辆、充电站；主要度量包括充电时长、充电电量、充电过程的最高温度、是否发生异常（布尔值）等。通过该表可计算平均充电时长、异常率等充电安全指标。

- 电池告警事实表 (FactBatteryAlert)：粒度为每一条电池安全相关的告警事件。维度关联有日期、车辆、告警类型；度量包括告警值（如温度值）、告警持续时间、是否导致措施（如限速/停车）等。该事实用于统计分析电池故障/告警的频率和特征。

- 报警响应事实表 (FactAlarmResponse)：粒度为每一起报警及其响应处理过程。维度包括报警日期、车辆、报警类型；可能还有响应团队/人员维度。度量包括响应开始时间、响应结束时间、响应耗时、处理结果（成功/失败）等。这张表可以和报警事件表一一对应或合并，用于评估报警处理效率。

- 用户投诉事实表 (FactComplaint)：粒度为每条用户安全投诉记录。维度关联有投诉日期、车辆、用户、投诉类别；度量包括投诉严重程度评分、处理时长、处理结果（是否关闭）等。此表数据来自售后系统，每条代表用户报告的一个安全/质量问题。
...

## Summary model design (DWS)
在 DWS层，我们以维度模型为基础，设计了各主题域的汇总表和宽表，用于提升复杂分析的性能和简化使用。DWS层的汇总模型以主题域/分析场景为单位，将细粒度的事实数据按照常用维度聚合，形成宽表（宽度大、字段多的一张表）供OLAP和报表直接查询。
主要宽表设计：
- 车辆安全日汇总宽表：粒度为车辆-日期（每辆车每天一条记录）。该宽表整合了行车安全和电池安全的主要指标，例如：当日行驶里程、行驶时长、急刹次数、超速次数、事故次数、事故严重度最高值、当日电池告警次数、电池最高温度等字段。通过车辆安全日汇总表，可以方便地按日追踪每辆车的安全状态或按车型、地区汇总比较。例如，查询特定车型在某月平均每日告警次数等，无需连接多张事实表。

- 充电安全汇总表：粒度可设为车辆-月份或充电站-月份等，视分析需求而定。若以车辆-月份为例，每辆车每月一条记录，汇总字段包括本月充电总次数、异常充电次数、异常率、平均单次充电时长、本月最大充电温度等等。若以充电站-月份，则每站每月一条，包含该站点充电会话总数、异常数、异常率等，用于评估站点安全表现。此表可以按站点运营商、地区等维度进一步聚合分析。

- 用户安全投诉汇总表：例如以月份为粒度，每月一条记录（或按地区/车型细分），字段包括当月新增投诉数、平均处理时长、处理及时率、未解决投诉数等。这张汇总表服务于高层查看总体投诉情况的报表。由于投诉总量相对不大，也可直接通过FineBI从事实表按需汇总，但提前汇总可减少计算开销。

- 报警响应绩效宽表：粒度为季度-响应团队，每个响应团队每季度一条记录，统计其处理的报警数、平均响应时间、超时未响应数等KPI指标。管理者可通过此宽表比较不同团队或不同时段的应急响应绩效。

### 说明
在汇总表设计时，我们遵循 “一张宽表尽量涵盖一个主题常用的90%指标” 的经验。过宽的表字段太多会导致维护和使用困难，但字段过少又无法起到减少关联的作用。因此我们选取关键指标入表，其余特别分析再另行计算。对于需要多时间粒度（如周、月、季度）汇总的情况，我们通常以日汇总为基础，通过视图或物化表进一步聚合出周/月指标。同时，非常规的计算指标，如同比环比、排名等，可以留在BI工具中动态计算或者在ADS层通过派生表实现，不强求体现在DWS宽表内，以免宽表列过于繁杂。

## 数据生命周期和分区策略
- Hive表分区策略：绝大部分事实表按事件发生日期进行分区，这是最常见也最有效的分区方式。例如车辆状态日志明细表以log_date（按天）分区，事故事实表以accident_date分区，充电会话表以charge_date分区等。按日分区能将每次查询所扫描的数据限制在所需日期范围内，显著减少数据扫描量。
- 冷热数据分层和保留策略：根据数据的新鲜度和使用频率，我们将数据划分为“热数据”和“冷数据”。一般最近一年的数据为热数据，查询频繁，需要保存在集群上以供快速访问；一年以前的数据为冷数据，查询概率低，可以从主集群卸载以节省资源。
- 数据版本与追溯：ODS层我们尽可能保留原始数据的完整历史，以支持数据质量追溯和问题分析。因此，对于ODS层一些关键数据，如事故记录，我们不更新原有记录而是采用追加+有效标记的方式记录修改，或者将变更记录在日志表中，确保可以还原任一时刻的状态。
- 备份与恢复：为了数据安全，我们对关键表（事故、投诉等表以及重要维度表）设置了定期备份策略。
