# DIM 层维度建模说明文档（Dimension Layer）

## 1. 设计概述（Design Overview）

DIM 层（Dimension Layer）位于数仓架构的公共层，其核心目的是保证维度的一致性。通过对 ODS 层分散的业务表进行清洗、整合与反规范化（Denormalization），构建出“宽表化”的维度模型，为下游（DWD / DWS / ADS）提供标准统一的分析视角。

---

## 1.1 命名规范

遵循 `dim_{业务域}_{表名}_{存储策略}` 的命名规则：

- `dim_`：层级前缀  
- `_zip`：拉链表（Zipper Table），用于记录随时间变化的维度（SCD Type 2），如车辆、用户  
- `_full`：全量快照表（Full Snapshot），用于记录每日全量状态，适用于数据量适中且需保留每日状态的维度，如电池包、充电桩  
- `_dict` / `_ref`（可选扩展）：静态字典 / 参考表（若后续需要）

---

## 1.2 设计方法论

本次设计严格遵循以下步骤：

1. **确定维度**：基于业务总线矩阵，识别出分析实体（如：车、人、电池、桩、故障）。
2. **确定主表/相关表**：锚定 ODS 层的主表（如 `vehicle_master`），并关联相关表（如 `vehicle_model`）进行属性扩展。
3. **确定维度属性**：沉淀通用属性，进行代码转文字（Code-to-Desc）与计算加工（如年龄段划分）。

---

# 2. 核心维度表详细设计

## 2.1 车辆维度表（核心）

- **表名**：`dim_vehicle_zip`  
- **类型**：SCD Type 2（拉链表）  
- **描述**：记录车辆全生命周期的静态属性及状态变更，是质量分析最核心的维度。

### 设计要素

| 模块 | 内容 |
|---|---|
| 主维表 | `ods_biz_vehicle_master_full`（车辆档案） |
| 相关维表 | `ods_biz_vehicle_model_full`（车型配置）<br>`ods_biz_vehicle_owner_rel_full`（人车关系）<br>`ods_biz_sim_card_full`（车联网卡） |
| 核心属性 | **基础信息**：VIN码、车牌号、车身颜色、发动机号<br>**时间属性**：生产日期、销售日期、上牌日期<br>**车型退化**：车型名称、车系、动力类型（EV / PHEV）、续航里程<br>**管理属性**：当前车主ID、销售区域、经销商、SIM卡运营商 |
| 变更策略 | 车辆的车主、车牌、归属地可能变更。使用 `start_date` / `end_date` 记录每一段状态有效期 |

---

## 2.2 用户维度表

- **表名**：`dim_user_zip`  
- **类型**：SCD Type 2（拉链表）  
- **描述**：记录车主个人画像信息，用于分析驾驶行为与“人”的关系（如新手司机事故率）。

### 设计要素

| 模块 | 内容 |
|---|---|
| 主维表 | `ods_biz_user_master_full` |
| 相关维表 | 无（单表维度） |
| 核心属性 | **标识**：用户ID、手机号（脱敏）<br>**画像**：性别、年龄、年龄段（计算属性）、常驻城市<br>**资质**：驾龄、驾照等级（C1 / C2） |
| 特有逻辑 | **年龄段沉淀**：ETL 将连续 `age` 转为离散 `age_group`（如 `25-35岁`），方便下游分组统计 |

---

## 2.3 电池包零部件维度表

- **表名**：`dim_battery_pack_full`  
- **类型**：每日全量快照  
- **描述**：针对“电池安全”业务，提供电池包生产溯源信息。

### 设计要素

| 模块 | 内容 |
|---|---|
| 主维表 | `ods_biz_battery_pack_full` |
| 相关维表 | `ods_biz_supplier_info_full`（供应商信息） |
| 核心属性 | **规格**：电池包编码、额定电压、额定容量（kWh）、电芯数量<br>**技术路线**：化学体系（三元 / 铁锂 / 固态）、冷却方式<br>**溯源**：电池包生产商、电芯供应商、生产批次号 |

---

## 2.4 充电设施维度表

- **表名**：`dim_charging_pile_full`  
- **类型**：每日全量快照  
- **描述**：将“充电站”与“充电桩”合并，以充电桩为最小粒度。

### 设计要素

| 模块 | 内容 |
|---|---|
| 主维表 | `ods_biz_charging_pile_full`（桩） |
| 相关维表 | `ods_biz_charging_station_full`（站） |
| 核心属性 | **桩属性**：桩ID、桩编号、功率（kW）、接口类型（国标 DC / AC）<br>**站属性（退化）**：所属场站名称、运营商（特来电 / 国网）、场站经纬度、所在省市 |

---

## 2.5 故障码字典表

- **表名**：`dim_fault_code_full`  
- **类型**：全量覆盖（Overwrite）  
- **描述**：静态字典表，用于将 T-BOX 上报的 Hex 故障码转义为中文描述。

### 设计要素

| 模块 | 内容 |
|---|---|
| 主维表 | `ods_biz_fault_code_dict_full` |
| 核心属性 | **标识**：故障码（Hex）、SPN-FMI 组合<br>**描述**：故障中文名称、维修指导建议<br>**分类**：风险等级（L1-L3）、所属子系统（BMS / MCU / VCU） |

---

# 3. 关键技术实现规范

## 3.1 SCD Type 2（拉链表）构建逻辑

对于 `dim_vehicle_zip` 与 `dim_user_zip`，为了保留历史状态，采用拉链算法：

### 输入数据

- **历史表**：昨日生成维度表（`end_date = '9999-12-31'` 为有效记录）
- **增量表**：今日 ODS 层发生变化或新增的数据

### 处理流程

- **Step 1（闭环）**：识别增量表中出现的旧记录，将其 `end_date` 更新为昨日
- **Step 2（开环）**：将增量表记录作为新版本插入，`start_date` 为今日，`end_date` 为 `9999-12-31`
- **Step 3（保持）**：未发生变化的记录原样保留

### 使用方式

- 查询当前状态：`WHERE end_date = '9999-12-31'`
- 查询历史某天状态：  
  `WHERE '2023-01-01' >= start_date AND '2023-01-01' <= end_date`

---

## 3.2 维度退化（Degenerate Dimension）

为了减少 Join 操作、提升查询性能，将部分相关维表属性直接物理存储在主维表中：

- **车型信息**：不单独建立 `dim_model` 表，将 `model_name`、`vehicle_type` 等冗余存储在 `dim_vehicle_zip` 中
- **充电站信息**：不单独建立 `dim_station` 表，直接冗余在 `dim_charging_pile_full` 中

---

## 3.3 数据丰富化（Enrichment）

DIM 层 ETL 过程中，必须完成以下数据治理动作：

- **空值填充**：所有 `NULL` 转为默认值（字符串 `'Unknown'`，数值 `-1`），防止关联时数据丢失
- **字典翻译**：将业务库字典代码转换为易读文本（如 `gender: 1 -> '男'`）
- **脱敏处理**：对车主姓名、手机号、身份证号进行掩码处理（Masking）

---

# 4. 存储与性能优化

- **文件格式**：统一采用 ORC 格式，利用列式存储特性加速分析型查询
- **压缩算法**：采用 Snappy 压缩，平衡解压速度与存储空间
- **分区策略**：
  - `_full` 表：按日期（`dt`）分区，每日保留一份完整快照
  - `_zip` 表：通常不分区（全量存储）或按 `start_date` 年份分区（视数据规模而定）

---

# 5. 总结

本设计方案规划了 6 张核心维度表，覆盖新能源汽车质量安全业务中的六大实体：**人（用户）、车（车辆）、零部件（电池）、设施（充电桩）、故障（字典）、地域（行政区）**。
