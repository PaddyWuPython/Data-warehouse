# DWS 层设计说明文档

## 1. 设计概述（Design Overview）

### 1.1 DWS 层定位与设计要点

**DWS（Data Warehouse Summary/Service）层**是数仓的汇总服务层，是连接明细层（DWD）与应用层（ADS）的关键枢纽。

#### 核心设计要点

1. **基于指标体系设计**：DWS 层的表结构与字段设计严格参照质量安全部门的**指标体系**，确保指标口径统一、可追溯  
2. **存储格式**：ORC 列式存储 + Snappy 压缩，支持高效的列裁剪与谓词下推  
3. **命名规范**：`dws_{数据域}_{统计粒度}_{业务过程}_{统计周期}`
   - 数据域：drive（行车）、batt（电池）、chg（充电）、safe（安全/报警）、user（用户）
   - 统计粒度：vehicle（车辆）、region（区域）、model（车型）、station（站点）等
   - 业务过程：running（行驶）、behavior（驾驶行为）、health（健康）、alarm（报警）等
   - 统计周期：
     - **1d**：最近1日（当日数据）
     - **nd**：最近n日（如 7d/30d，滚动窗口）
     - **td**：历史至今（to-date，累计值）
4. **分区策略**：按统计日期（`dt`）分区，支持增量更新与历史回溯  
5. **多粒度设计**：同一业务过程支持多种统计粒度（车辆/区域/车型），满足不同分析需求  

***

## 2. 指标体系（Metric System）

在设计 DWS 层之前，需明确五大业务域的**核心指标体系**，确保所有汇总表的指标口径一致。

### 2.1 行车安全域指标

| 指标分类 | 指标名称 | 指标定义 | 计算口径 |
|---|---|---|---|
| **基础运行** | 活跃车辆数 | 当日有行驶数据的车辆数 | COUNT(DISTINCT vin) WHERE vehicle_status=1 |
|  | 总里程 | 累计行驶里程 | SUM(odometer_end - odometer_start) |
|  | 车均里程 | 车辆平均行驶里程 | 总里程 / 活跃车辆数 |
|  | 行驶时长 | 车辆状态=启动的总时长 | SUM(duration) WHERE vehicle_status=1 |
| **能耗指标** | 总能耗 | 累计消耗电能 | SUM(energy_consumption_kwh) |
|  | 百公里能耗 | 单位里程能耗 | 总能耗 / 总里程 * 100 |
| **安全事件** | 风险事件总数 | 驾驶行为风险事件次数 | COUNT(*) FROM behavior_event |
|  | 万公里风险事件率 | 单位里程风险事件频率 | 风险事件总数 / 总里程 * 10000 |
|  | 驾驶评分 | 综合驾驶行为评分 | 100 - (急刹*2 + 急加速*1.5 + 超速*3 + ...) |

### 2.2 电池安全域指标

| 指标分类 | 指标名称 | 指标定义 | 计算口径 |
|---|---|---|---|
| **健康度** | 平均SOC | 电池荷电状态平均值 | AVG(soc) |
|  | 平均SOH | 电池健康度平均值 | AVG(soh) |
|  | SOH衰减率 | 相比上月SOH变化 | (本月SOH - 上月SOH) / 上月SOH |
| **一致性** | 平均压差 | 单体电压最大差值 | AVG(max_voltage - min_voltage) |
|  | 压差异常次数 | 压差超过阈值的次数 | COUNT(*) WHERE voltage_diff > 0.1V |
|  | 温差异常次数 | 温差超过阈值的次数 | COUNT(*) WHERE temp_diff > 10℃ |
| **热安全** | 过温次数 | 温度超过55℃的次数 | COUNT(*) WHERE max_temp > 55 |
|  | 热失控风险车辆数 | 温度>60℃或温差>15℃的车辆 | COUNT(DISTINCT vin) WHERE 触发条件 |
|  | 平均最高温度 | 电池最高温度平均值 | AVG(max_temp) |

### 2.3 充电安全域指标

| 指标分类 | 指标名称 | 指标定义 | 计算口径 |
|---|---|---|---|
| **充电量** | 总充电次数 | 充电会话总数 | COUNT(*) FROM charging_session |
|  | 总充电电量 | 累计充电电能 | SUM(charged_energy) |
|  | 车均充电次数 | 车辆平均充电次数 | 总充电次数 / 充电车辆数 |
| **质量指标** | 充电异常次数 | 异常中断的会话数 | COUNT(*) WHERE session_status='ABNORMAL' |
|  | 充电异常率 | 异常次数占比 | 充电异常次数 / 总充电次数 * 100% |
|  | 过温充电次数 | 充电时温度>50℃ | COUNT(*) WHERE max_temp > 50 |
| **效率指标** | 平均充电功率 | 充电功率平均值 | AVG(avg_power) |
|  | 平均充电时长 | 单次充电平均时长 | AVG(charge_duration_min) |
|  | 桩利用率 | 充电桩使用时长占比 | 充电时长 / (24*桩数量) * 100% |

### 2.4 告警响应域指标

| 指标分类 | 指标名称 | 指标定义 | 计算口径 |
|---|---|---|---|
| **报警量** | 总报警次数 | 故障码触发总数 | COUNT(*) FROM alarm_detail |
|  | 报警车辆数 | 触发报警的车辆数 | COUNT(DISTINCT vin) |
|  | 报警车辆率 | 报警车辆占总车辆比例 | 报警车辆数 / 总车辆数 * 100% |
|  | 严重报警次数 | 等级3的报警次数 | COUNT(*) WHERE fault_level=3 |
| **响应时效** | 平均响应时长 | 从报警到工单创建的时长 | AVG(response_lag_sec) |
|  | 响应SLA达标率 | 5分钟内响应的占比 | COUNT(*) WHERE response_lag_sec<=300 / 总数 |
|  | 平均处理时长 | 工单处理耗时 | AVG(handle_duration_hour) |
| **处理质量** | 工单解决率 | 已解决工单占比 | 已解决数 / 总工单数 * 100% |
|  | 误报率 | 误报工单占比 | 误报数 / 总工单数 * 100% |
|  | 平均用户评分 | 用户反馈评分 | AVG(feedback_score) |

### 2.5 用户安全域指标

| 指标分类 | 指标名称 | 指标定义 | 计算口径 |
|---|---|---|---|
| **投诉量** | 总投诉数 | 投诉工单总数 | COUNT(*) |
|  | 安全类投诉数 | 安全相关投诉 | COUNT(*) WHERE complaint_type IN (...) |
|  | 千车投诉率 | 单位车辆投诉频率 | 总投诉数 / 总车辆数 * 1000 |
| **时效性** | 平均响应时长 | 从提交到受理的时长 | AVG(response_lag_hour) |
|  | 响应SLA达标率 | 2小时内响应的占比 | COUNT(*) WHERE <=2h / 总数 |
|  | 平均处理时长 | 投诉处理耗时 | AVG(handle_duration_day) |
| **质量指标** | 质量问题确认率 | 确认为质量问题的占比 | 质量问题数 / 总投诉数 * 100% |
|  | 平均满意度 | 用户满意度评分 | AVG(user_satisfaction) |
|  | 升级率 | 投诉升级占比 | 升级数 / 总投诉数 * 100% |

